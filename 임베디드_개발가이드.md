# 임베디드 개발자를 위한 Firebase 연동 가이드

## 🎯 개발 목표
- 센서를 통한 상품 스캔 데이터를 Firebase에 실시간 전송
- 사용자 이동거리 측정 및 포인트 적립 시스템 구현
- 카트 등록/해제 및 사용자 인증 연동

## 🔧 개발 환경 설정

### 1. Firebase 프로젝트 설정
```bash
# Firebase CLI 설치
npm install -g firebase-tools

# Firebase 프로젝트 로그인
firebase login

# 프로젝트 초기화
firebase init database
```

### 2. 필요한 라이브러리
```cpp
// Arduino/ESP32용 Firebase 라이브러리
#include "FirebaseESP32.h"
#include "WiFi.h"
#include "ArduinoJson.h"

// 또는 Python용
pip install firebase-admin
```

## 📡 센서 데이터 전송 구현

### 1. 바코드 스캔 시 장바구니 추가

#### C++ (Arduino/ESP32) 예시:
```cpp
#include <FirebaseESP32.h>

// Firebase 설정
#define FIREBASE_HOST "your-project.firebaseio.com"
#define FIREBASE_AUTH "your-database-secret"

FirebaseData firebaseData;

// 바코드 스캔 시 호출할 함수
void addItemToCart(String cartNumber, String barcode, String productName, int price) {
  String path = "/carts/" + cartNumber + "/items/" + barcode;
  
  FirebaseJson json;
  json.set("name", productName);
  json.set("price", price);
  json.set("quantity", 1);
  json.set("barcode", barcode);
  json.set("addedAt", millis()); // 현재 시간
  
  if (Firebase.setJSON(firebaseData, path, json)) {
    Serial.println("✅ 상품이 장바구니에 추가되었습니다");
  } else {
    Serial.println("❌ 오류: " + firebaseData.errorReason());
  }
}

// 수량 업데이트 (같은 상품 재스캔 시)
void updateItemQuantity(String cartNumber, String barcode, int newQuantity) {
  String path = "/carts/" + cartNumber + "/items/" + barcode + "/quantity";
  
  if (Firebase.setInt(firebaseData, path, newQuantity)) {
    Serial.println("✅ 수량이 업데이트되었습니다");
  }
}
```

#### Python 예시:
```python
import firebase_admin
from firebase_admin import credentials, db
import json
import time

# Firebase 초기화
cred = credentials.Certificate("path/to/serviceAccountKey.json")
firebase_admin.initialize_app(cred, {
    'databaseURL': 'https://your-project.firebaseio.com'
})

def add_item_to_cart(cart_number, barcode, product_name, price):
    """바코드 스캔 시 장바구니에 상품 추가"""
    path = f"/carts/{cart_number}/items/{barcode}"
    
    item_data = {
        "name": product_name,
        "price": price,
        "quantity": 1,
        "barcode": barcode,
        "addedAt": int(time.time() * 1000)
    }
    
    try:
        ref = db.reference(path)
        ref.set(item_data)
        print(f"✅ {product_name}이 장바구니에 추가되었습니다")
    except Exception as e:
        print(f"❌ 오류: {e}")

def update_quantity(cart_number, barcode, new_quantity):
    """상품 수량 업데이트"""
    path = f"/carts/{cart_number}/items/{barcode}/quantity"
    
    try:
        ref = db.reference(path)
        ref.set(new_quantity)
        print(f"✅ 수량이 {new_quantity}로 업데이트되었습니다")
    except Exception as e:
        print(f"❌ 오류: {e}")
```

### 2. 카트 등록/해제 시스템

#### 카트 등록:
```cpp
void registerCart(String cartNumber, String userId) {
  String path = "/carts/" + cartNumber;
  
  FirebaseJson json;
  json.set("inUse", true);
  json.set("userId", userId);
  json.set("registeredAt", millis());
  
  Firebase.setJSON(firebaseData, path, json);
}

// 카트 해제
void unregisterCart(String cartNumber) {
  String path = "/carts/" + cartNumber;
  
  FirebaseJson json;
  json.set("inUse", false);
  json.set("userId", "");
  json.set("registeredAt", millis());
  
  Firebase.setJSON(firebaseData, path, json);
}
```

### 3. 상품 정보 조회

```cpp
void checkProductInfo(String barcode) {
  String path = "/products/" + barcode;
  
  if (Firebase.getJSON(firebaseData, path)) {
    FirebaseJson json = firebaseData.jsonObject();
    FirebaseJsonData jsonData;
    
    json.get(jsonData, "name");
    String productName = jsonData.stringValue;
    
    json.get(jsonData, "price");
    int price = jsonData.intValue;
    
    json.get(jsonData, "inStock");
    bool inStock = jsonData.boolValue;
    
    if (inStock) {
      Serial.println("✅ 상품: " + productName + ", 가격: " + String(price));
    } else {
      Serial.println("❌ 품절된 상품입니다");
    }
  }
}
```

## 🏃‍♂️ 이동거리 측정 및 포인트 적립

### 1. GPS/가속도계 센서를 통한 거리 측정

```cpp
#include "TinyGPS++.h"

TinyGPSPlus gps;
float lastLat = 0, lastLon = 0;
float totalDistance = 0;

void updateDistance() {
  if (gps.location.isValid()) {
    float currentLat = gps.location.lat();
    float currentLon = gps.location.lng();
    
    if (lastLat != 0 && lastLon != 0) {
      // 거리 계산 (미터 단위)
      float distance = calculateDistance(lastLat, lastLon, currentLat, currentLon);
      totalDistance += distance;
      
      // 50m 이상 이동 시 포인트 적립
      if (totalDistance >= 50) {
        addDistancePoints(currentUserId, totalDistance);
        totalDistance = 0; // 리셋
      }
    }
    
    lastLat = currentLat;
    lastLon = currentLon;
  }
}

float calculateDistance(float lat1, float lon1, float lat2, float lon2) {
  // Haversine 공식을 사용한 거리 계산
  const float R = 6371000; // 지구 반지름 (미터)
  float dLat = radians(lat2 - lat1);
  float dLon = radians(lon2 - lon1);
  
  float a = sin(dLat/2) * sin(dLat/2) +
            cos(radians(lat1)) * cos(radians(lat2)) *
            sin(dLon/2) * sin(dLon/2);
  
  float c = 2 * atan2(sqrt(a), sqrt(1-a));
  return R * c;
}
```

### 2. 포인트 적립 API 호출

```cpp
void addDistancePoints(String userId, float distance) {
  // Firebase Functions API 호출
  String url = "https://your-project.cloudfunctions.net/addDistancePoints";
  
  FirebaseJson json;
  json.set("userId", userId);
  json.set("distance", (int)distance);
  
  HTTPClient http;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  
  String jsonString;
  json.toString(jsonString);
  
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode > 0) {
    String response = http.getString();
    Serial.println("✅ 포인트 적립 완료: " + response);
  } else {
    Serial.println("❌ HTTP 오류: " + String(httpResponseCode));
  }
  
  http.end();
}
```

### 3. 직접 Firebase 업데이트 (API 없이)

```cpp
void addPointsDirectly(String userId, int points) {
  // 현재 포인트 조회
  String pointsPath = "/users/" + userId + "/points";
  FirebaseData currentPointsData;
  
  int currentPoints = 0;
  if (Firebase.getInt(currentPointsData, pointsPath)) {
    currentPoints = currentPointsData.intData();
  }
  
  // 포인트 업데이트
  Firebase.setInt(firebaseData, pointsPath, currentPoints + points);
  
  // 총 거리 업데이트
  String distancePath = "/users/" + userId + "/totalDistance";
  FirebaseData currentDistanceData;
  
  int currentDistance = 0;
  if (Firebase.getInt(currentDistanceData, distancePath)) {
    currentDistance = currentDistanceData.intData();
  }
  
  Firebase.setInt(firebaseData, distancePath, currentDistance + 50);
  
  // 포인트 내역 추가
  String historyPath = "/users/" + userId + "/pointHistory";
  FirebaseJson historyJson;
  historyJson.set("amount", points);
  historyJson.set("type", "earned");
  historyJson.set("reason", "distance");
  historyJson.set("description", "50m 이동");
  historyJson.set("timestamp", millis());
  
  Firebase.pushJSON(firebaseData, historyPath, historyJson);
}
```

## 🔐 사용자 인증 연동

### 1. 카트 번호와 사용자 연결

```cpp
void linkCartToUser(String cartNumber, String userId) {
  // 1. 카트 등록
  registerCart(cartNumber, userId);
  
  // 2. 사용자 정보에 카트 번호 저장
  String userPath = "/users/" + userId + "/cartNumber";
  Firebase.setString(firebaseData, userPath, cartNumber);
  
  Serial.println("✅ 카트 " + cartNumber + "번이 사용자에게 연결되었습니다");
}
```

### 2. 카트 사용 상태 확인

```cpp
bool isCartAvailable(String cartNumber) {
  String path = "/carts/" + cartNumber + "/inUse";
  
  FirebaseData data;
  if (Firebase.getBool(data, path)) {
    return !data.boolData(); // inUse가 false면 사용 가능
  }
  return false;
}
```

## 📱 하드웨어 구성 예시

### ESP32 + 바코드 스캐너 + GPS 모듈
```cpp
// 핀 설정
#define BARCODE_SCANNER_RX 16
#define BARCODE_SCANNER_TX 17
#define GPS_RX 18
#define GPS_TX 19

// WiFi 설정
const char* ssid = "your-wifi-name";
const char* password = "your-wifi-password";

void setup() {
  Serial.begin(115200);
  
  // WiFi 연결
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("WiFi 연결 중...");
  }
  
  // Firebase 초기화
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);
  
  // 센서 초기화
  setupBarcodeScanner();
  setupGPS();
  
  Serial.println("✅ 시스템 초기화 완료");
}

void loop() {
  // 바코드 스캔 감지
  if (barcodeScanner.available()) {
    String barcode = barcodeScanner.readString();
    barcode.trim();
    
    // 상품 정보 조회 후 장바구니 추가
    checkProductInfo(barcode);
  }
  
  // GPS 데이터 처리
  while (Serial2.available() > 0) {
    if (gps.encode(Serial2.read())) {
      updateDistance();
    }
  }
  
  delay(100);
}
```

## ⚠️ 주의사항 및 최적화

### 1. 에러 처리
```cpp
void handleFirebaseError(FirebaseData &data) {
  if (!data.httpCode()) {
    Serial.println("❌ 네트워크 오류: " + data.errorReason());
  } else if (data.httpCode() != HTTP_CODE_OK) {
    Serial.println("❌ HTTP 오류: " + String(data.httpCode()));
  }
}
```

### 2. 데이터 검증
```cpp
bool validateBarcode(String barcode) {
  // 13자리 숫자 검증
  if (barcode.length() != 13) return false;
  
  for (int i = 0; i < barcode.length(); i++) {
    if (!isDigit(barcode.charAt(i))) return false;
  }
  
  return true;
}
```

### 3. 배터리 최적화
```cpp
// 깊은 수면 모드 활용
void enterDeepSleep(int seconds) {
  esp_sleep_enable_timer_wakeup(seconds * 1000000);
  esp_deep_sleep_start();
}

// WiFi 연결 최적화
void optimizeWiFi() {
  WiFi.setSleep(false); // WiFi 절전 모드 비활성화
  WiFi.setTxPower(WIFI_POWER_11dBm); // 전송 파워 조절
}
```

## 🧪 테스트 시나리오

### 1. 바코드 스캔 테스트
```
1. 카트 등록: "001" 번 카트를 사용자에게 연결
2. 상품 스캔: "8801234567890" (신라면) 스캔
3. 확인: Firebase에서 carts/001/items/8801234567890 데이터 확인
4. 재스캔: 같은 상품 재스캔하여 수량 증가 확인
```

### 2. 포인트 적립 테스트
```
1. GPS 모듈로 이동거리 측정
2. 50m 이동 시 포인트 적립 확인
3. Firebase에서 users/{userId}/points 증가 확인
4. 포인트 내역에 기록 추가 확인
```

이 가이드를 따라 개발하면 프론트엔드와 완벽하게 연동되는 임베디드 시스템을 구축할 수 있습니다! 🚀
