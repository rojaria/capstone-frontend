# ì„ë² ë””ë“œ ê°œë°œìë¥¼ ìœ„í•œ Firebase ì—°ë™ ê°€ì´ë“œ

## ğŸ¯ ê°œë°œ ëª©í‘œ
- ì„¼ì„œë¥¼ í†µí•œ ìƒí’ˆ ìŠ¤ìº” ë°ì´í„°ë¥¼ Firebaseì— ì‹¤ì‹œê°„ ì „ì†¡
- ì‚¬ìš©ì ì´ë™ê±°ë¦¬ ì¸¡ì • ë° í¬ì¸íŠ¸ ì ë¦½ ì‹œìŠ¤í…œ êµ¬í˜„
- ì¹´íŠ¸ ë“±ë¡/í•´ì œ ë° ì‚¬ìš©ì ì¸ì¦ ì—°ë™

## ğŸ”§ ê°œë°œ í™˜ê²½ ì„¤ì •

### 1. Firebase í”„ë¡œì íŠ¸ ì„¤ì •
```bash
# Firebase CLI ì„¤ì¹˜
npm install -g firebase-tools

# Firebase í”„ë¡œì íŠ¸ ë¡œê·¸ì¸
firebase login

# í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
firebase init database
```

### 2. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
```cpp
// Arduino/ESP32ìš© Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬
#include "FirebaseESP32.h"
#include "WiFi.h"
#include "ArduinoJson.h"

// ë˜ëŠ” Pythonìš©
pip install firebase-admin
```

## ğŸ“¡ ì„¼ì„œ ë°ì´í„° ì „ì†¡ êµ¬í˜„

### 1. ë°”ì½”ë“œ ìŠ¤ìº” ì‹œ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€

#### C++ (Arduino/ESP32) ì˜ˆì‹œ:
```cpp
#include <FirebaseESP32.h>

// Firebase ì„¤ì •
#define FIREBASE_HOST "your-project.firebaseio.com"
#define FIREBASE_AUTH "your-database-secret"

FirebaseData firebaseData;

// ë°”ì½”ë“œ ìŠ¤ìº” ì‹œ í˜¸ì¶œí•  í•¨ìˆ˜
void addItemToCart(String cartNumber, String barcode, String productName, int price) {
  String path = "/carts/" + cartNumber + "/items/" + barcode;
  
  FirebaseJson json;
  json.set("name", productName);
  json.set("price", price);
  json.set("quantity", 1);
  json.set("barcode", barcode);
  json.set("addedAt", millis()); // í˜„ì¬ ì‹œê°„
  
  if (Firebase.setJSON(firebaseData, path, json)) {
    Serial.println("âœ… ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤");
  } else {
    Serial.println("âŒ ì˜¤ë¥˜: " + firebaseData.errorReason());
  }
}

// ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ (ê°™ì€ ìƒí’ˆ ì¬ìŠ¤ìº” ì‹œ)
void updateItemQuantity(String cartNumber, String barcode, int newQuantity) {
  String path = "/carts/" + cartNumber + "/items/" + barcode + "/quantity";
  
  if (Firebase.setInt(firebaseData, path, newQuantity)) {
    Serial.println("âœ… ìˆ˜ëŸ‰ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤");
  }
}
```

#### Python ì˜ˆì‹œ:
```python
import firebase_admin
from firebase_admin import credentials, db
import json
import time

# Firebase ì´ˆê¸°í™”
cred = credentials.Certificate("path/to/serviceAccountKey.json")
firebase_admin.initialize_app(cred, {
    'databaseURL': 'https://your-project.firebaseio.com'
})

def add_item_to_cart(cart_number, barcode, product_name, price):
    """ë°”ì½”ë“œ ìŠ¤ìº” ì‹œ ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ì¶”ê°€"""
    path = f"/carts/{cart_number}/items/{barcode}"
    
    item_data = {
        "name": product_name,
        "price": price,
        "quantity": 1,
        "barcode": barcode,
        "addedAt": int(time.time() * 1000)
    }
    
    try:
        ref = db.reference(path)
        ref.set(item_data)
        print(f"âœ… {product_name}ì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")

def update_quantity(cart_number, barcode, new_quantity):
    """ìƒí’ˆ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸"""
    path = f"/carts/{cart_number}/items/{barcode}/quantity"
    
    try:
        ref = db.reference(path)
        ref.set(new_quantity)
        print(f"âœ… ìˆ˜ëŸ‰ì´ {new_quantity}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")
```

### 2. ì¹´íŠ¸ ë“±ë¡/í•´ì œ ì‹œìŠ¤í…œ

#### ì¹´íŠ¸ ë“±ë¡:
```cpp
void registerCart(String cartNumber, String userId) {
  String path = "/carts/" + cartNumber;
  
  FirebaseJson json;
  json.set("inUse", true);
  json.set("userId", userId);
  json.set("registeredAt", millis());
  
  Firebase.setJSON(firebaseData, path, json);
}

// ì¹´íŠ¸ í•´ì œ
void unregisterCart(String cartNumber) {
  String path = "/carts/" + cartNumber;
  
  FirebaseJson json;
  json.set("inUse", false);
  json.set("userId", "");
  json.set("registeredAt", millis());
  
  Firebase.setJSON(firebaseData, path, json);
}
```

### 3. ìƒí’ˆ ì •ë³´ ì¡°íšŒ

```cpp
void checkProductInfo(String barcode) {
  String path = "/products/" + barcode;
  
  if (Firebase.getJSON(firebaseData, path)) {
    FirebaseJson json = firebaseData.jsonObject();
    FirebaseJsonData jsonData;
    
    json.get(jsonData, "name");
    String productName = jsonData.stringValue;
    
    json.get(jsonData, "price");
    int price = jsonData.intValue;
    
    json.get(jsonData, "inStock");
    bool inStock = jsonData.boolValue;
    
    if (inStock) {
      Serial.println("âœ… ìƒí’ˆ: " + productName + ", ê°€ê²©: " + String(price));
    } else {
      Serial.println("âŒ í’ˆì ˆëœ ìƒí’ˆì…ë‹ˆë‹¤");
    }
  }
}
```

## ğŸƒâ€â™‚ï¸ ì´ë™ê±°ë¦¬ ì¸¡ì • ë° í¬ì¸íŠ¸ ì ë¦½

### 1. GPS/ê°€ì†ë„ê³„ ì„¼ì„œë¥¼ í†µí•œ ê±°ë¦¬ ì¸¡ì •

```cpp
#include "TinyGPS++.h"

TinyGPSPlus gps;
float lastLat = 0, lastLon = 0;
float totalDistance = 0;

void updateDistance() {
  if (gps.location.isValid()) {
    float currentLat = gps.location.lat();
    float currentLon = gps.location.lng();
    
    if (lastLat != 0 && lastLon != 0) {
      // ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
      float distance = calculateDistance(lastLat, lastLon, currentLat, currentLon);
      totalDistance += distance;
      
      // 50m ì´ìƒ ì´ë™ ì‹œ í¬ì¸íŠ¸ ì ë¦½
      if (totalDistance >= 50) {
        addDistancePoints(currentUserId, totalDistance);
        totalDistance = 0; // ë¦¬ì…‹
      }
    }
    
    lastLat = currentLat;
    lastLon = currentLon;
  }
}

float calculateDistance(float lat1, float lon1, float lat2, float lon2) {
  // Haversine ê³µì‹ì„ ì‚¬ìš©í•œ ê±°ë¦¬ ê³„ì‚°
  const float R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
  float dLat = radians(lat2 - lat1);
  float dLon = radians(lon2 - lon1);
  
  float a = sin(dLat/2) * sin(dLat/2) +
            cos(radians(lat1)) * cos(radians(lat2)) *
            sin(dLon/2) * sin(dLon/2);
  
  float c = 2 * atan2(sqrt(a), sqrt(1-a));
  return R * c;
}
```

### 2. í¬ì¸íŠ¸ ì ë¦½ API í˜¸ì¶œ

```cpp
void addDistancePoints(String userId, float distance) {
  // Firebase Functions API í˜¸ì¶œ
  String url = "https://your-project.cloudfunctions.net/addDistancePoints";
  
  FirebaseJson json;
  json.set("userId", userId);
  json.set("distance", (int)distance);
  
  HTTPClient http;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  
  String jsonString;
  json.toString(jsonString);
  
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode > 0) {
    String response = http.getString();
    Serial.println("âœ… í¬ì¸íŠ¸ ì ë¦½ ì™„ë£Œ: " + response);
  } else {
    Serial.println("âŒ HTTP ì˜¤ë¥˜: " + String(httpResponseCode));
  }
  
  http.end();
}
```

### 3. ì§ì ‘ Firebase ì—…ë°ì´íŠ¸ (API ì—†ì´)

```cpp
void addPointsDirectly(String userId, int points) {
  // í˜„ì¬ í¬ì¸íŠ¸ ì¡°íšŒ
  String pointsPath = "/users/" + userId + "/points";
  FirebaseData currentPointsData;
  
  int currentPoints = 0;
  if (Firebase.getInt(currentPointsData, pointsPath)) {
    currentPoints = currentPointsData.intData();
  }
  
  // í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
  Firebase.setInt(firebaseData, pointsPath, currentPoints + points);
  
  // ì´ ê±°ë¦¬ ì—…ë°ì´íŠ¸
  String distancePath = "/users/" + userId + "/totalDistance";
  FirebaseData currentDistanceData;
  
  int currentDistance = 0;
  if (Firebase.getInt(currentDistanceData, distancePath)) {
    currentDistance = currentDistanceData.intData();
  }
  
  Firebase.setInt(firebaseData, distancePath, currentDistance + 50);
  
  // í¬ì¸íŠ¸ ë‚´ì—­ ì¶”ê°€
  String historyPath = "/users/" + userId + "/pointHistory";
  FirebaseJson historyJson;
  historyJson.set("amount", points);
  historyJson.set("type", "earned");
  historyJson.set("reason", "distance");
  historyJson.set("description", "50m ì´ë™");
  historyJson.set("timestamp", millis());
  
  Firebase.pushJSON(firebaseData, historyPath, historyJson);
}
```

## ğŸ” ì‚¬ìš©ì ì¸ì¦ ì—°ë™

### 1. ì¹´íŠ¸ ë²ˆí˜¸ì™€ ì‚¬ìš©ì ì—°ê²°

```cpp
void linkCartToUser(String cartNumber, String userId) {
  // 1. ì¹´íŠ¸ ë“±ë¡
  registerCart(cartNumber, userId);
  
  // 2. ì‚¬ìš©ì ì •ë³´ì— ì¹´íŠ¸ ë²ˆí˜¸ ì €ì¥
  String userPath = "/users/" + userId + "/cartNumber";
  Firebase.setString(firebaseData, userPath, cartNumber);
  
  Serial.println("âœ… ì¹´íŠ¸ " + cartNumber + "ë²ˆì´ ì‚¬ìš©ìì—ê²Œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤");
}
```

### 2. ì¹´íŠ¸ ì‚¬ìš© ìƒíƒœ í™•ì¸

```cpp
bool isCartAvailable(String cartNumber) {
  String path = "/carts/" + cartNumber + "/inUse";
  
  FirebaseData data;
  if (Firebase.getBool(data, path)) {
    return !data.boolData(); // inUseê°€ falseë©´ ì‚¬ìš© ê°€ëŠ¥
  }
  return false;
}
```

## ğŸ“± í•˜ë“œì›¨ì–´ êµ¬ì„± ì˜ˆì‹œ

### ESP32 + ë°”ì½”ë“œ ìŠ¤ìºë„ˆ + GPS ëª¨ë“ˆ
```cpp
// í•€ ì„¤ì •
#define BARCODE_SCANNER_RX 16
#define BARCODE_SCANNER_TX 17
#define GPS_RX 18
#define GPS_TX 19

// WiFi ì„¤ì •
const char* ssid = "your-wifi-name";
const char* password = "your-wifi-password";

void setup() {
  Serial.begin(115200);
  
  // WiFi ì—°ê²°
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("WiFi ì—°ê²° ì¤‘...");
  }
  
  // Firebase ì´ˆê¸°í™”
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);
  
  // ì„¼ì„œ ì´ˆê¸°í™”
  setupBarcodeScanner();
  setupGPS();
  
  Serial.println("âœ… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ");
}

void loop() {
  // ë°”ì½”ë“œ ìŠ¤ìº” ê°ì§€
  if (barcodeScanner.available()) {
    String barcode = barcodeScanner.readString();
    barcode.trim();
    
    // ìƒí’ˆ ì •ë³´ ì¡°íšŒ í›„ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€
    checkProductInfo(barcode);
  }
  
  // GPS ë°ì´í„° ì²˜ë¦¬
  while (Serial2.available() > 0) {
    if (gps.encode(Serial2.read())) {
      updateDistance();
    }
  }
  
  delay(100);
}
```

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ìµœì í™”

### 1. ì—ëŸ¬ ì²˜ë¦¬
```cpp
void handleFirebaseError(FirebaseData &data) {
  if (!data.httpCode()) {
    Serial.println("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + data.errorReason());
  } else if (data.httpCode() != HTTP_CODE_OK) {
    Serial.println("âŒ HTTP ì˜¤ë¥˜: " + String(data.httpCode()));
  }
}
```

### 2. ë°ì´í„° ê²€ì¦
```cpp
bool validateBarcode(String barcode) {
  // 13ìë¦¬ ìˆ«ì ê²€ì¦
  if (barcode.length() != 13) return false;
  
  for (int i = 0; i < barcode.length(); i++) {
    if (!isDigit(barcode.charAt(i))) return false;
  }
  
  return true;
}
```

### 3. ë°°í„°ë¦¬ ìµœì í™”
```cpp
// ê¹Šì€ ìˆ˜ë©´ ëª¨ë“œ í™œìš©
void enterDeepSleep(int seconds) {
  esp_sleep_enable_timer_wakeup(seconds * 1000000);
  esp_deep_sleep_start();
}

// WiFi ì—°ê²° ìµœì í™”
void optimizeWiFi() {
  WiFi.setSleep(false); // WiFi ì ˆì „ ëª¨ë“œ ë¹„í™œì„±í™”
  WiFi.setTxPower(WIFI_POWER_11dBm); // ì „ì†¡ íŒŒì›Œ ì¡°ì ˆ
}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ë°”ì½”ë“œ ìŠ¤ìº” í…ŒìŠ¤íŠ¸
```
1. ì¹´íŠ¸ ë“±ë¡: "001" ë²ˆ ì¹´íŠ¸ë¥¼ ì‚¬ìš©ìì—ê²Œ ì—°ê²°
2. ìƒí’ˆ ìŠ¤ìº”: "8801234567890" (ì‹ ë¼ë©´) ìŠ¤ìº”
3. í™•ì¸: Firebaseì—ì„œ carts/001/items/8801234567890 ë°ì´í„° í™•ì¸
4. ì¬ìŠ¤ìº”: ê°™ì€ ìƒí’ˆ ì¬ìŠ¤ìº”í•˜ì—¬ ìˆ˜ëŸ‰ ì¦ê°€ í™•ì¸
```

### 2. í¬ì¸íŠ¸ ì ë¦½ í…ŒìŠ¤íŠ¸
```
1. GPS ëª¨ë“ˆë¡œ ì´ë™ê±°ë¦¬ ì¸¡ì •
2. 50m ì´ë™ ì‹œ í¬ì¸íŠ¸ ì ë¦½ í™•ì¸
3. Firebaseì—ì„œ users/{userId}/points ì¦ê°€ í™•ì¸
4. í¬ì¸íŠ¸ ë‚´ì—­ì— ê¸°ë¡ ì¶”ê°€ í™•ì¸
```

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼ ê°œë°œí•˜ë©´ í”„ë¡ íŠ¸ì—”ë“œì™€ ì™„ë²½í•˜ê²Œ ì—°ë™ë˜ëŠ” ì„ë² ë””ë“œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€
